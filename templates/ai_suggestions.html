{% extends "base.html" %}

{% block title %}AI Suggestions - Material Delivery Dashboard{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex justify-between items-center">
        <h2 class="text-3xl font-bold text-pkp-green">
            <i class="fas fa-robot mr-2 text-pkp-gold"></i>
            AI Suggestions Review
        </h2>
        <div class="flex items-center space-x-4">
            <button onclick="loadSuggestions()" class="bg-pkp-green hover:bg-pkp-gold hover:text-pkp-green text-white px-4 py-2 rounded-lg transition shadow-md">
                <i class="fas fa-sync-alt mr-2"></i>
                Refresh
            </button>
        </div>
    </div>

    <!-- Info Banner -->
    <div class="bg-green-50 border-l-4 border-pkp-green p-4 rounded shadow-sm">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-indigo-500 text-xl"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-bold text-indigo-800">About AI Suggestions</h3>
                <p class="text-sm text-indigo-700 mt-1">
                    AI automatically extracts data from emails and documents. 
                    <strong>High confidence (≥90%)</strong> suggestions are auto-applied.
                    <strong>Medium confidence (60-89%)</strong> require your review.
                    <strong>Low confidence (&lt;60%)</strong> are discarded.
                </p>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-md p-4">
        <div class="flex items-center space-x-4">
            <label class="text-gray-700 font-semibold">Filter:</label>
            <select id="filter-status" class="border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="all">All Suggestions</option>
                <option value="pending" selected>Pending Review</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
                <option value="auto_applied">Auto-Applied</option>
            </select>
            
            <select id="filter-table" class="border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="all">All Tables</option>
                <option value="materials">Materials</option>
                <option value="purchase_orders">Purchase Orders</option>
                <option value="payments">Payments</option>
                <option value="deliveries">Deliveries</option>
            </select>
            
            <select id="filter-confidence" class="border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="all">All Confidence Levels</option>
                <option value="high">High (≥90%)</option>
                <option value="medium">Medium (60-89%)</option>
                <option value="low">Low (&lt;60%)</option>
            </select>
        </div>
    </div>

    <!-- Suggestions List -->
    <div id="suggestions-container" class="space-y-4">
        <div class="text-center text-gray-500 py-8">
            <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
            <p>Loading suggestions...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allSuggestions = [];

function loadSuggestions() {
    $.ajax({
        url: '/api/ai_suggestions',
        method: 'GET',
        success: function(data) {
            allSuggestions = data;
            displaySuggestions(data);
        },
        error: function(err) {
            $('#suggestions-container').html(`
                <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                    <p class="text-red-700">Error loading suggestions: ${err.responseJSON?.error || 'Unknown error'}</p>
                </div>
            `);
        }
    });
}

function displaySuggestions(suggestions) {
    const container = $('#suggestions-container');
    container.empty();
    
    if (suggestions.length === 0) {
        container.html(`
            <div class="bg-green-50 border-l-4 border-green-500 p-6 rounded text-center">
                <i class="fas fa-check-circle text-green-500 text-3xl mb-3"></i>
                <p class="text-green-700 font-semibold">No suggestions to review!</p>
                <p class="text-green-600 text-sm mt-2">All AI suggestions have been processed.</p>
            </div>
        `);
        return;
    }
    
    suggestions.forEach(suggestion => {
        const card = createSuggestionCard(suggestion);
        container.append(card);
    });
}

function createSuggestionCard(s) {
    const confidenceColor = s.confidence_score >= 90 ? 'bg-green-100 text-green-800' : 
                           s.confidence_score >= 60 ? 'bg-yellow-100 text-yellow-800' : 
                           'bg-red-100 text-red-800';
    
    const statusColor = s.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                       s.status === 'approved' ? 'bg-green-100 text-green-800' :
                       s.status === 'rejected' ? 'bg-red-100 text-red-800' :
                       'bg-blue-100 text-blue-800';
    
    let card = `
        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition">
            <!-- Header -->
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-gray-800">
                        ${s.action_type.toUpperCase()} ${s.target_table.replace('_', ' ').toUpperCase()}
                    </h3>
                    <p class="text-sm text-gray-600 mt-1">
                        Source: ${s.extraction_source} | AI Model: ${s.ai_model}
                    </p>
                </div>
                <div class="flex flex-col items-end space-y-2">
                    <span class="px-3 py-1 rounded-full text-sm font-semibold ${confidenceColor}">
                        ${s.confidence_score}% Confidence
                    </span>
                    <span class="px-3 py-1 rounded-full text-sm font-semibold ${statusColor}">
                        ${s.status.replace('_', ' ').toUpperCase()}
                    </span>
                </div>
            </div>
            
            <!-- AI Reasoning -->
            ${s.ai_reasoning ? `
            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded mb-4">
                <p class="text-sm text-gray-700">
                    <strong class="text-blue-700">AI Reasoning:</strong> ${escapeHtml(s.ai_reasoning)}
                </p>
            </div>
            ` : ''}
            
            <!-- Suggested Data -->
            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                <h4 class="font-semibold text-gray-800 mb-2">Suggested Changes:</h4>
                <div class="space-y-2">
                    ${Object.entries(s.suggested_data).map(([key, value]) => `
                        <div class="flex justify-between">
                            <span class="text-gray-600 font-medium">${key}:</span>
                            <span class="text-gray-800">${escapeHtml(String(value))}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <!-- Missing Fields -->
            ${s.missing_fields && s.missing_fields.length > 0 ? `
            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 rounded mb-4">
                <p class="text-sm text-yellow-800">
                    <strong>Missing Fields:</strong> ${s.missing_fields.join(', ')}
                </p>
            </div>
            ` : ''}
            
            <!-- Actions -->
            ${s.status === 'pending' ? `
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="rejectSuggestion(${s.id})" 
                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-times mr-2"></i>Reject
                </button>
                <button onclick="approveSuggestion(${s.id})" 
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-check mr-2"></i>Approve
                </button>
            </div>
            ` : ''}
            
            <!-- Review Info -->
            ${s.reviewed_by ? `
            <div class="mt-4 pt-4 border-t text-sm text-gray-600">
                <p>Reviewed by ${s.reviewed_by} on ${formatDate(s.reviewed_at)}</p>
                ${s.review_notes ? `<p class="mt-1"><em>"${escapeHtml(s.review_notes)}"</em></p>` : ''}
            </div>
            ` : ''}
            
            <!-- Timestamp -->
            <div class="mt-4 text-xs text-gray-500">
                Created: ${formatDate(s.created_at)}
            </div>
        </div>
    `;
    
    return card;
}

function approveSuggestion(id) {
    const notes = prompt('Add review notes (optional):');
    
    if (confirm('Approve this AI suggestion?')) {
        window.dashboardUtils.showLoading();
        
        $.ajax({
            url: `/api/ai_suggestions/${id}/approve`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({
                reviewed_by: 'User',
                review_notes: notes || ''
            }),
            success: function(response) {
                window.dashboardUtils.hideLoading();
                window.dashboardUtils.showToast('Suggestion approved successfully!', 'success');
                loadSuggestions();
            },
            error: function(err) {
                window.dashboardUtils.hideLoading();
                window.dashboardUtils.showToast('Error approving suggestion', 'error');
            }
        });
    }
}

function rejectSuggestion(id) {
    const notes = prompt('Reason for rejection:');
    
    if (notes && confirm('Reject this AI suggestion?')) {
        window.dashboardUtils.showLoading();
        
        $.ajax({
            url: `/api/ai_suggestions/${id}/reject`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({
                reviewed_by: 'User',
                review_notes: notes
            }),
            success: function(response) {
                window.dashboardUtils.hideLoading();
                window.dashboardUtils.showToast('Suggestion rejected', 'info');
                loadSuggestions();
            },
            error: function(err) {
                window.dashboardUtils.hideLoading();
                window.dashboardUtils.showToast('Error rejecting suggestion', 'error');
            }
        });
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleString();
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return String(text).replace(/[&<>"']/g, m => map[m]);
}

// Filter handling
$('#filter-status, #filter-table, #filter-confidence').on('change', function() {
    const statusFilter = $('#filter-status').val();
    const tableFilter = $('#filter-table').val();
    const confidenceFilter = $('#filter-confidence').val();
    
    let filtered = allSuggestions;
    
    if (statusFilter !== 'all') {
        filtered = filtered.filter(s => s.status === statusFilter);
    }
    
    if (tableFilter !== 'all') {
        filtered = filtered.filter(s => s.target_table === tableFilter);
    }
    
    if (confidenceFilter !== 'all') {
        filtered = filtered.filter(s => {
            if (confidenceFilter === 'high') return s.confidence_score >= 90;
            if (confidenceFilter === 'medium') return s.confidence_score >= 60 && s.confidence_score < 90;
            if (confidenceFilter === 'low') return s.confidence_score < 60;
            return true;
        });
    }
    
    displaySuggestions(filtered);
});

// Initialize
$(document).ready(function() {
    loadSuggestions();
    
    // Auto-refresh every 30 seconds
    setInterval(loadSuggestions, 30000);
});
</script>
{% endblock %}
