{% extends "base.html" %}

{% block title %}LPO Management - Material Delivery Dashboard{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex justify-between items-center">
        <h2 class="text-3xl font-bold text-pkp-green">
            <i class="fas fa-file-invoice mr-2 text-pkp-gold"></i>
            Local Purchase Orders (LPO)
        </h2>
        <button onclick="showAddLpoModal()" class="bg-pkp-green hover:bg-pkp-gold hover:text-pkp-green text-white px-6 py-3 rounded-lg transition font-semibold shadow-md">
            <i class="fas fa-plus mr-2"></i>Create New LPO
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-pkp-gold">
        <div class="flex items-center space-x-4">
            <label class="text-gray-700 font-semibold">Filter:</label>
            <select id="filter-status" class="border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="all">All Status</option>
                <option value="draft">Draft</option>
                <option value="issued">Issued</option>
                <option value="received">Received</option>
                <option value="cancelled">Cancelled</option>
            </select>
            
            <input type="text" id="search-box" placeholder="Search LPOs..." 
                   class="border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 flex-1">
            
            <button onclick="loadLpos()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition">
                <i class="fas fa-sync-alt mr-2"></i>Refresh
            </button>
        </div>
    </div>

    <!-- LPO Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50 border-b">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">LPO Number</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Amount</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="lpo-table-body" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading LPOs...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit LPO Modal -->
<div id="lpo-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg w-full max-w-6xl max-h-[90vh] overflow-y-auto m-4">
        <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
            <h3 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-file-invoice text-pkp-green mr-2"></i>
                <span id="modal-title">Create New LPO</span>
            </h3>
            <button onclick="closeLpoModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>

        <div id="lpo-modal-content" class="p-6">
            <!-- Step 1: Upload Quote -->
            <div id="uploadSection" class="space-y-6">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <p class="text-blue-800 font-medium">
                        <i class="fas fa-info-circle mr-2"></i>
                        Upload a supplier quotation to auto-extract details
                    </p>
                    <p class="text-blue-600 text-sm mt-1">Supported formats: PDF, DOCX, XLSX (Max 20MB)</p>
                </div>

                <!-- File Upload Area -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-pkp-green transition cursor-pointer"
                     id="dropZone"
                     ondrop="handleDrop(event)" 
                     ondragover="handleDragOver(event)" 
                     ondragleave="handleDragLeave(event)">
                    <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                    <p class="text-lg text-gray-700 font-semibold mb-2">Drag & Drop Quote File Here</p>
                    <p class="text-sm text-gray-500 mb-4">or</p>
                    <input type="file" id="fileInput" class="hidden" accept=".pdf,.docx,.xlsx,.doc,.xls" onchange="handleFileSelect(event)">
                    <button type="button" onclick="document.getElementById('fileInput').click()" 
                            class="bg-pkp-green hover:bg-pkp-gold hover:text-pkp-green text-white px-6 py-2 rounded-lg transition font-semibold">
                        <i class="fas fa-folder-open mr-2"></i>Browse Files
                    </button>
                </div>

                <!-- Selected File Display -->
                <div id="selectedFile" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-file-pdf text-red-500 text-2xl"></i>
                            <div>
                                <p class="font-semibold text-gray-800" id="fileName"></p>
                                <p class="text-sm text-gray-500" id="fileSize"></p>
                            </div>
                        </div>
                        <button onclick="clearFile()" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Extract Button -->
                <div class="flex justify-end">
                    <button onclick="extractQuoteData()" 
                            id="extractButton"
                            disabled
                            class="bg-pkp-green hover:bg-pkp-gold hover:text-pkp-green text-white px-8 py-3 rounded-lg transition font-semibold shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <i class="fas fa-magic mr-2"></i>Extract Data with AI
                    </button>
                </div>
            </div>

            <!-- Step 2: Loading State -->
            <div id="loadingSection" class="hidden text-center py-12 space-y-6">
                <div class="relative inline-block">
                    <div class="w-24 h-24 border-8 border-gray-200 border-t-pkp-green rounded-full animate-spin"></div>
                    <i class="fas fa-robot text-4xl text-pkp-green absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></i>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-gray-800">Extracting Data...</h3>
                    <p class="text-gray-600 mt-2">AI is analyzing the quotation</p>
                    <p class="text-sm text-gray-500 mt-4">This may take 10-30 seconds</p>
                </div>
            </div>

            <!-- Step 3: LPO Form -->
            <div id="lpoFormSection" class="hidden space-y-6">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <p class="text-green-800 font-medium">
                        <i class="fas fa-check-circle mr-2"></i>
                        Data extracted successfully! Review and edit details below.
                    </p>
                </div>

                <!-- Form will be dynamically inserted here -->
                <div id="lpoFormContent"></div>

                <!-- Action Buttons -->
                <div class="flex space-x-4 pt-4 border-t sticky bottom-0 bg-white py-4">
                    <button onclick="saveLPODraft()" 
                            class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-semibold transition">
                        <i class="fas fa-save mr-2"></i>Save Draft
                    </button>
                    <button onclick="generateLPOPDF()" 
                            class="flex-1 bg-pkp-green hover:bg-pkp-gold hover:text-pkp-green text-white py-3 rounded-lg font-semibold transition shadow-md">
                        <i class="fas fa-file-pdf mr-2"></i>Generate LPO PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedFile = null;
    let extractedData = null;

    // Load LPOs on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadLpos();
    });

    // Load LPO List
    async function loadLpos() {
        const tbody = document.getElementById('lpo-table-body');
        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading LPOs...</td></tr>';

        try {
            const response = await fetch('/api/lpo/list');
            const result = await response.json();

            if (result.lpos && result.lpos.length > 0) {
                tbody.innerHTML = result.lpos.map(lpo => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="font-semibold text-gray-900">${lpo.lpo_number}</span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900 font-medium">${lpo.supplier_name}</div>
                            ${lpo.supplier_trn ? `<div class="text-xs text-gray-500">TRN: ${lpo.supplier_trn}</div>` : ''}
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${lpo.project_name || '-'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                ${lpo.status === 'issued' ? 'bg-green-100 text-green-800' : ''}
                                ${lpo.status === 'draft' ? 'bg-yellow-100 text-yellow-800' : ''}
                                ${lpo.status === 'received' ? 'bg-blue-100 text-blue-800' : ''}
                                ${lpo.status === 'cancelled' ? 'bg-red-100 text-red-800' : ''}">
                                ${lpo.status.toUpperCase()}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <div class="text-sm font-semibold text-gray-900">${parseFloat(lpo.total_amount).toFixed(2)} AED</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${new Date(lpo.created_at).toLocaleDateString()}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="downloadLPO(${lpo.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                                <i class="fas fa-download"></i>
                            </button>
                            <button onclick="viewLPO(${lpo.id})" class="text-green-600 hover:text-green-900 mr-3">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${lpo.status === 'draft' ? `
                                <button onclick="editLPO(${lpo.id})" class="text-yellow-600 hover:text-yellow-900 mr-3">
                                    <i class="fas fa-edit"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No LPOs found</td></tr>';
            }
        } catch (error) {
            console.error('Error:', error);
            tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-red-500">Error loading LPOs</td></tr>';
        }
    }

    // Show Add LPO Modal
    function showAddLpoModal() {
        document.getElementById('lpo-modal').classList.remove('hidden');
        document.getElementById('uploadSection').classList.remove('hidden');
        document.getElementById('loadingSection').classList.add('hidden');
        document.getElementById('lpoFormSection').classList.add('hidden');
        clearFile();
    }

    // Close Modal
    function closeLpoModal() {
        document.getElementById('lpo-modal').classList.add('hidden');
        selectedFile = null;
        extractedData = null;
    }

    // File Upload Handlers
    function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add('border-pkp-green', 'bg-green-50');
    }

    function handleDragLeave(e) {
        e.currentTarget.classList.remove('border-pkp-green', 'bg-green-50');
    }

    function handleDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('border-pkp-green', 'bg-green-50');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    }

    function handleFileSelect(e) {
        const files = e.target.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    }

    function handleFile(file) {
        const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 
                             'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                             'application/msword', 'application/vnd.ms-excel'];
        const maxSize = 20 * 1024 * 1024; // 20MB

        if (!allowedTypes.includes(file.type)) {
            alert('Invalid file type. Please upload PDF, DOCX, or XLSX files.');
            return;
        }

        if (file.size > maxSize) {
            alert('File size exceeds 20MB limit.');
            return;
        }

        selectedFile = file;
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatFileSize(file.size);
        document.getElementById('selectedFile').classList.remove('hidden');
        document.getElementById('extractButton').disabled = false;
    }

    function clearFile() {
        selectedFile = null;
        document.getElementById('selectedFile').classList.add('hidden');
        document.getElementById('extractButton').disabled = true;
        document.getElementById('fileInput').value = '';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Extract Quote Data
    async function extractQuoteData() {
        if (!selectedFile) return;

        document.getElementById('uploadSection').classList.add('hidden');
        document.getElementById('loadingSection').classList.remove('hidden');

        const formData = new FormData();
        formData.append('file', selectedFile);

        try {
            const response = await fetch('/api/n8n/lpo-extract-quote', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Extraction failed');
            }

            extractedData = await response.json();
            renderLPOForm(extractedData);
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('lpoFormSection').classList.remove('hidden');

        } catch (error) {
            console.error('Error:', error);
            alert('Failed to extract data. Please try again or enter manually.');
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('uploadSection').classList.remove('hidden');
        }
    }

    // Download LPO
    function downloadLPO(id) {
        window.open(`/api/n8n/lpo-download/${id}`, '_blank');
    }

    // View LPO
    function viewLPO(id) {
        alert('View LPO details - Coming soon!');
    }

    // Edit LPO
    function editLPO(id) {
        alert('Edit LPO - Coming soon!');
    }

    // [FORM RENDERING FUNCTIONS FROM STEP 5.3]
    // These functions handle the dynamic LPO form with AI-extracted data
    
    // Render LPO Form with extracted data
    function renderLPOForm(data) {
        console.log('Rendering form with data:', data);
        
        // Store data for later use
        if (data.data) {
            extractedData = data.data;
        } else {
            extractedData = data;
        }
        
        const formData = extractedData;
        const supplier = formData.supplier || {};
        const terms = formData.terms || {};
        const columnStructure = formData.column_structure || ["DESCRIPTION", "UNIT", "QTY", "RATE"];
        const items = formData.items || [];
        
        // Build form HTML (same as chat.html implementation)
        const formHTML = `
            <!-- Supplier Information Section -->
            <div class="bg-white rounded-lg border border-gray-200 p-6 space-y-4">
                <h4 class="font-semibold text-gray-700 flex items-center space-x-2 border-b pb-2">
                    <i class="fas fa-building text-blue-500"></i>
                    <span>Supplier Information</span>
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Supplier Name *</label>
                        <input type="text" id="supplierName" value="${supplier.name || ''}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">TRN</label>
                        <input type="text" id="supplierTrn" value="${supplier.trn || ''}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                        <input type="text" id="supplierAddress" value="${supplier.address || ''}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Telephone</label>
                        <input type="text" id="supplierTel" value="${supplier.tel || ''}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contact Person</label>
                        <input type="text" id="supplierContact" value="${supplier.contact_person || ''}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>

            <!-- Project & Quote Information Section -->
            <div class="bg-white rounded-lg border border-gray-200 p-6 space-y-4">
                <h4 class="font-semibold text-gray-700 flex items-center space-x-2 border-b pb-2">
                    <i class="fas fa-project-diagram text-purple-500"></i>
                    <span>Project & Quote Details</span>
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Project Name *</label>
                        <input type="text" id="projectName" value="${formData.project_name || ''}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Project Location</label>
                        <input type="text" id="projectLocation" value="${formData.project_location || ''}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Quote Reference</label>
                        <input type="text" id="quoteRef" value="${formData.quote_ref || ''}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Quote Date</label>
                        <input type="date" id="quoteDate" value="${formData.quote_date || ''}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>

            <!-- Items Table Section -->
            <div class="bg-white rounded-lg border border-gray-200 p-6 space-y-4">
                <div class="flex items-center justify-between border-b pb-2">
                    <h4 class="font-semibold text-gray-700 flex items-center space-x-2">
                        <i class="fas fa-list text-green-500"></i>
                        <span>Items</span>
                    </h4>
                    <button onclick="addItemRow()" 
                            class="bg-pkp-green hover:bg-pkp-gold hover:text-pkp-green text-white px-4 py-1.5 rounded-lg text-sm font-medium transition">
                        <i class="fas fa-plus"></i> Add Item
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm" id="itemsTable">
                        <thead class="bg-gray-50 border-b-2 border-gray-200">
                            <tr>
                                <th class="px-2 py-2 text-left font-semibold text-gray-700 w-12">#</th>
                                ${columnStructure.map(col => 
                                    `<th class="px-2 py-2 text-left font-semibold text-gray-700">${col}</th>`
                                ).join('')}
                                <th class="px-2 py-2 text-right font-semibold text-gray-700">AMOUNT</th>
                                <th class="px-2 py-2 text-center font-semibold text-gray-700 w-16">
                                    <i class="fas fa-trash text-gray-400"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                            <!-- Items will be dynamically inserted -->
                        </tbody>
                    </table>
                </div>

                <!-- Totals Section -->
                <div class="border-t pt-4 mt-4">
                    <div class="flex justify-end">
                        <div class="w-full md:w-1/2 space-y-2">
                            <div class="flex justify-between items-center py-2 border-b">
                                <span class="font-medium text-gray-700">Subtotal:</span>
                                <span class="text-lg font-semibold text-gray-800" id="subtotalDisplay">0.00 AED</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b">
                                <span class="font-medium text-gray-700">VAT (5%):</span>
                                <span class="text-lg font-semibold text-gray-800" id="vatDisplay">0.00 AED</span>
                            </div>
                            <div class="flex justify-between items-center py-3 bg-green-50 px-4 rounded-lg">
                                <span class="font-bold text-gray-800 text-lg">Grand Total:</span>
                                <span class="text-2xl font-bold text-pkp-green" id="grandTotalDisplay">0.00 AED</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Terms & Conditions Section -->
            <div class="bg-white rounded-lg border border-gray-200 p-6 space-y-4">
                <h4 class="font-semibold text-gray-700 flex items-center space-x-2 border-b pb-2">
                    <i class="fas fa-file-contract text-orange-500"></i>
                    <span>Terms & Conditions</span>
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Payment Terms</label>
                        <input type="text" id="paymentTerms" value="${terms.payment || ''}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="e.g., 30 days from delivery">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Terms</label>
                        <input type="text" id="deliveryTerms" value="${terms.delivery || ''}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="e.g., Within 7 days from PO">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Additional Notes</label>
                        <textarea id="additionalNotes" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                  placeholder="Any additional terms or conditions...">${terms.notes || ''}</textarea>
                    </div>
                </div>
            </div>
        `;
        
        // Insert form HTML
        document.getElementById('lpoFormContent').innerHTML = formHTML;
        
        // Store column structure globally
        window.lpoColumnStructure = columnStructure;
        
        // Populate items table
        if (items.length > 0) {
            items.forEach((item, index) => {
                addItemRow(item);
            });
        } else {
            // Add one empty row
            addItemRow();
        }
        
        // Calculate totals
        calculateTotals();
    }

    // Add Item Row to table
    function addItemRow(itemData = null) {
        const tbody = document.getElementById('itemsTableBody');
        const rowCount = tbody.children.length + 1;
        const columnStructure = window.lpoColumnStructure || ["DESCRIPTION", "UNIT", "QTY", "RATE"];
        
        const row = document.createElement('tr');
        row.className = 'border-b hover:bg-gray-50 transition';
        row.dataset.rowId = rowCount;
        
        // Build row HTML
        let rowHTML = `<td class="px-2 py-2 text-gray-600 font-medium">${rowCount}</td>`;
        
        // Add input for each column
        columnStructure.forEach(col => {
            const colKey = col.toLowerCase().replace(/\s+/g, '_');
            let value = '';
            let inputType = 'text';
            let inputClass = 'w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500';
            
            // Get value from itemData
            if (itemData) {
                value = itemData[colKey] || itemData[col.toLowerCase()] || '';
            }
            
            // Numeric columns
            if (['QTY', 'RATE', 'QUANTITY', 'PRICE'].includes(col.toUpperCase())) {
                inputType = 'number';
                inputClass += ' text-right';
                if (value) value = parseFloat(value).toFixed(2);
            }
            
            rowHTML += `
                <td class="px-2 py-2">
                    <input type="${inputType}" 
                           data-column="${col}" 
                           value="${value}" 
                           onchange="calculateTotals()"
                           class="${inputClass}"
                           ${inputType === 'number' ? 'step="0.01" min="0"' : ''}>
                </td>
            `;
        });
        
        // Amount column (calculated)
        rowHTML += `
            <td class="px-2 py-2">
                <input type="text" 
                       class="w-full px-2 py-1.5 bg-gray-50 border border-gray-200 rounded text-right font-semibold text-gray-700" 
                       readonly 
                       data-amount 
                       value="0.00">
            </td>
        `;
        
        // Delete button
        rowHTML += `
            <td class="px-2 py-2 text-center">
                <button onclick="removeItemRow(this)" 
                        class="text-red-500 hover:text-red-700 hover:bg-red-50 px-2 py-1 rounded transition">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        row.innerHTML = rowHTML;
        tbody.appendChild(row);
        
        // Recalculate row numbers
        updateRowNumbers();
        calculateTotals();
    }

    // Remove Item Row
    function removeItemRow(button) {
        const row = button.closest('tr');
        row.remove();
        updateRowNumbers();
        calculateTotals();
    }

    // Update Row Numbers
    function updateRowNumbers() {
        const tbody = document.getElementById('itemsTableBody');
        Array.from(tbody.children).forEach((row, index) => {
            row.children[0].textContent = index + 1;
            row.dataset.rowId = index + 1;
        });
    }

    // Calculate Totals
    function calculateTotals() {
        const tbody = document.getElementById('itemsTableBody');
        const rows = Array.from(tbody.children);
        const columnStructure = window.lpoColumnStructure || ["DESCRIPTION", "UNIT", "QTY", "RATE"];
        
        let subtotal = 0;
        
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input[data-column]');
            let qty = 0;
            let rate = 0;
            
            inputs.forEach(input => {
                const col = input.dataset.column.toUpperCase();
                const value = parseFloat(input.value) || 0;
                
                if (['QTY', 'QUANTITY'].includes(col)) {
                    qty = value;
                } else if (['RATE', 'PRICE'].includes(col)) {
                    rate = value;
                }
            });
            
            const amount = qty * rate;
            subtotal += amount;
            
            // Update amount field in row
            const amountField = row.querySelector('input[data-amount]');
            if (amountField) {
                amountField.value = amount.toFixed(2);
            }
        });
        
        // Calculate VAT and Grand Total
        const vat = subtotal * 0.05; // 5% VAT
        const grandTotal = subtotal + vat;
        
        // Update display
        document.getElementById('subtotalDisplay').textContent = subtotal.toFixed(2) + ' AED';
        document.getElementById('vatDisplay').textContent = vat.toFixed(2) + ' AED';
        document.getElementById('grandTotalDisplay').textContent = grandTotal.toFixed(2) + ' AED';
    }

    // Collect Form Data
    function collectFormData() {
        const columnStructure = window.lpoColumnStructure || ["DESCRIPTION", "UNIT", "QTY", "RATE"];
        
        // Collect supplier data
        const supplier = {
            name: document.getElementById('supplierName').value,
            trn: document.getElementById('supplierTrn').value,
            address: document.getElementById('supplierAddress').value,
            tel: document.getElementById('supplierTel').value,
            contact_person: document.getElementById('supplierContact').value
        };
        
        // Collect project data
        const project_name = document.getElementById('projectName').value;
        const project_location = document.getElementById('projectLocation').value;
        const quote_ref = document.getElementById('quoteRef').value;
        const quote_date = document.getElementById('quoteDate').value;
        
        // Collect items
        const tbody = document.getElementById('itemsTableBody');
        const rows = Array.from(tbody.children);
        const items = rows.map((row, index) => {
            const item = { number: index + 1 };
            const inputs = row.querySelectorAll('input[data-column]');
            
            inputs.forEach(input => {
                const col = input.dataset.column;
                const colKey = col.toLowerCase().replace(/\s+/g, '_');
                const value = input.value;
                
                // Parse numeric values
                if (['QTY', 'RATE', 'QUANTITY', 'PRICE'].includes(col.toUpperCase())) {
                    item[colKey] = parseFloat(value) || 0;
                } else {
                    item[colKey] = value;
                }
            });
            
            // Add calculated amount
            const amountField = row.querySelector('input[data-amount]');
            item.amount = parseFloat(amountField.value) || 0;
            
            return item;
        }).filter(item => {
            // Filter out empty rows
            const descKey = columnStructure.find(col => 
                col.toUpperCase().includes('DESC')
            )?.toLowerCase().replace(/\s+/g, '_');
            return descKey ? item[descKey] : true;
        });
        
        // Collect terms
        const terms = {
            payment: document.getElementById('paymentTerms').value,
            delivery: document.getElementById('deliveryTerms').value,
            notes: document.getElementById('additionalNotes').value
        };
        
        // Return complete form data
        return {
            supplier,
            project_name,
            project_location,
            quote_ref,
            quote_date,
            column_structure: columnStructure,
            items,
            terms
        };
    }

    // Validate Form
    function validateForm() {
        const data = collectFormData();
        const errors = [];
        
        if (!data.supplier.name || data.supplier.name.trim() === '') {
            errors.push('Supplier name is required');
        }
        
        if (!data.project_name || data.project_name.trim() === '') {
            errors.push('Project name is required');
        }
        
        if (!data.items || data.items.length === 0) {
            errors.push('At least one item is required');
        }
        
        return { valid: errors.length === 0, errors };
    }

    // Save LPO Draft
    async function saveLPODraft() {
        const validation = validateForm();
        if (!validation.valid) {
            alert('Please fix the following errors:\n\n' + validation.errors.join('\n'));
            return;
        }
        
        const formData = collectFormData();
        formData.status = 'draft';
        
        console.log('Saving draft:', formData);
        alert('Draft save functionality coming soon!');
    }

    // Generate LPO PDF
    async function generateLPOPDF() {
        const validation = validateForm();
        if (!validation.valid) {
            alert('Please fix the following errors:\n\n' + validation.errors.join('\n'));
            return;
        }
        
        const formData = collectFormData();
        formData.status = 'issued';
        
        const button = event.target;
        const originalHTML = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
        
        try {
            const response = await fetch('/api/n8n/lpo-generate-pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            if (!response.ok) throw new Error('PDF generation failed');
            
            const result = await response.json();
            
            if (result.success) {
                alert(`✅ LPO Generated Successfully!\n\nLPO Number: ${result.lpo_number}\nGrand Total: ${result.totals.grand_total.toFixed(2)} AED\n\nDownloading PDF...`);
                window.open(result.pdf_url, '_blank');
                setTimeout(() => {
                    closeLpoModal();
                    loadLpos(); // Refresh the list
                }, 1000);
            } else {
                throw new Error(result.message || 'PDF generation failed');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('❌ Failed to generate LPO PDF.\n\n' + error.message);
        } finally {
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !document.getElementById('lpo-modal').classList.contains('hidden')) {
            closeLpoModal();
        }
    });

</script>
{% endblock %}
