{% extends "base.html" %}

{% block title %}Dashboard - Material Delivery Tracker{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex justify-between items-center">
        <h2 class="text-3xl font-bold text-gray-800">
            <i class="fas fa-chart-line mr-2 text-blue-600"></i>
            Dashboard Overview
        </h2>
        <div class="text-sm text-gray-600">
            <i class="fas fa-calendar mr-1"></i>
            <span id="current-date"></span>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Materials Card -->
        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-gray-600 font-semibold">Materials</h3>
                <i class="fas fa-boxes text-blue-600 text-2xl"></i>
            </div>
            <div class="space-y-2">
                <div class="text-3xl font-bold text-gray-800" id="total-materials">-</div>
                <div class="text-sm text-gray-600">
                    <span class="text-green-600 font-semibold" id="approved-materials">-</span> Approved /
                    <span class="text-yellow-600 font-semibold" id="pending-materials">-</span> Pending
                </div>
            </div>
        </div>

        <!-- Purchase Orders Card -->
        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-gray-600 font-semibold">Purchase Orders</h3>
                <i class="fas fa-file-invoice text-green-600 text-2xl"></i>
            </div>
            <div class="space-y-2">
                <div class="text-3xl font-bold text-gray-800" id="total-pos">-</div>
                <div class="text-sm text-gray-600">
                    Total Value: <span class="font-semibold text-green-600" id="total-po-value">-</span>
                </div>
            </div>
        </div>

        <!-- Deliveries Card -->
        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-gray-600 font-semibold">Deliveries</h3>
                <i class="fas fa-shipping-fast text-purple-600 text-2xl"></i>
            </div>
            <div class="space-y-2">
                <div class="text-3xl font-bold text-gray-800" id="total-deliveries">-</div>
                <div class="text-sm">
                    <span class="text-red-600 font-semibold" id="delayed-deliveries">-</span> Delayed /
                    <span class="text-yellow-600 font-semibold" id="pending-deliveries">-</span> Pending
                </div>
            </div>
        </div>

        <!-- AI Suggestions Card -->
        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-gray-600 font-semibold">AI Suggestions</h3>
                <i class="fas fa-robot text-indigo-600 text-2xl"></i>
            </div>
            <div class="space-y-2">
                <div class="text-3xl font-bold text-gray-800" id="pending-suggestions">-</div>
                <div class="text-sm text-gray-600">
                    <span class="text-indigo-600 font-semibold" id="high-confidence">-</span> High Confidence
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-pkp-gold">
        <h3 class="text-xl font-bold text-pkp-green mb-4">
            <i class="fas fa-bolt mr-2 text-pkp-gold"></i>
            Quick Actions
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <a href="/materials" class="btn-action bg-pkp-green hover:bg-pkp-gold hover:text-pkp-green">
                <i class="fas fa-plus-circle mr-2"></i>
                Add Material
            </a>
            <a href="/purchase_orders" class="btn-action bg-pkp-green hover:bg-pkp-gold hover:text-pkp-green">
                <i class="fas fa-file-invoice mr-2"></i>
                New PO
            </a>
            <a href="/deliveries" class="btn-action bg-pkp-green hover:bg-pkp-gold hover:text-pkp-green">
                <i class="fas fa-truck mr-2"></i>
                Track Delivery
            </a>
            <a href="/ai_suggestions" class="btn-action bg-pkp-green hover:bg-pkp-gold hover:text-pkp-green">
                <i class="fas fa-robot mr-2"></i>
                Review AI
            </a>
        </div>
    </div>

    <!-- Recent Activity & Alerts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Alerts -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>
                Alerts & Notifications
            </h3>
            <div id="alerts-list" class="space-y-3">
                <div class="text-gray-500 text-sm text-center py-4">Loading alerts...</div>
            </div>
        </div>

        <!-- Upcoming Deliveries -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-calendar-check mr-2 text-green-500"></i>
                Upcoming Deliveries
            </h3>
            <div id="upcoming-deliveries" class="space-y-3">
                <div class="text-gray-500 text-sm text-center py-4">Loading deliveries...</div>
            </div>
        </div>
    </div>
</div>

<style>
.btn-action {
    @apply text-white px-4 py-3 rounded-lg transition text-center font-semibold;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Load dashboard statistics
function loadDashboardStats() {
    $.ajax({
        url: '/api/dashboard/stats',
        method: 'GET',
        success: function(data) {
            // Materials
            $('#total-materials').text(data.materials.total);
            $('#approved-materials').text(data.materials.approved);
            $('#pending-materials').text(data.materials.pending);
            
            // Purchase Orders
            $('#total-pos').text(data.purchase_orders.total);
            $('#total-po-value').text('AED ' + data.purchase_orders.total_value.toLocaleString());
            
            // Deliveries
            $('#total-deliveries').text(data.deliveries.total);
            $('#delayed-deliveries').text(data.deliveries.delayed);
            $('#pending-deliveries').text(data.deliveries.pending);
            
            // AI Suggestions
            $('#pending-suggestions').text(data.ai_suggestions.pending);
            $('#high-confidence').text(data.ai_suggestions.high_confidence);
            
            // Update badge
            if (data.ai_suggestions.pending > 0) {
                $('#ai-badge').removeClass('hidden').text(data.ai_suggestions.pending);
            }
        },
        error: function(err) {
            console.error('Error loading dashboard stats:', err);
        }
    });
}

// Load upcoming deliveries
function loadUpcomingDeliveries() {
    $.ajax({
        url: '/api/deliveries/pending',
        method: 'GET',
        success: function(data) {
            const container = $('#upcoming-deliveries');
            container.empty();
            
            if (data.length === 0) {
                container.html('<div class="text-gray-500 text-sm text-center py-4">No upcoming deliveries</div>');
                return;
            }
            
            data.slice(0, 5).forEach(delivery => {
                const html = `
                    <div class="border-l-4 border-blue-500 pl-4 py-2">
                        <div class="font-semibold text-gray-800">${delivery.material_type || 'Unknown Material'}</div>
                        <div class="text-sm text-gray-600">PO: ${delivery.po_ref}</div>
                        <div class="text-sm text-gray-600">Expected: ${delivery.expected_delivery_date || 'TBD'}</div>
                        <span class="inline-block mt-1 px-2 py-1 text-xs rounded ${getStatusClass(delivery.delivery_status)}">
                            ${delivery.delivery_status}
                        </span>
                    </div>
                `;
                container.append(html);
            });
        }
    });
}

// Load alerts
function loadAlerts() {
    $.ajax({
        url: '/api/deliveries/delayed',
        method: 'GET',
        success: function(data) {
            const container = $('#alerts-list');
            container.empty();
            
            if (data.length === 0) {
                container.html('<div class="text-green-600 text-sm text-center py-4"><i class="fas fa-check-circle mr-2"></i>No alerts</div>');
                return;
            }
            
            data.slice(0, 5).forEach(delivery => {
                const html = `
                    <div class="bg-red-50 border-l-4 border-red-500 p-3 rounded">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-circle text-red-500 mr-2 mt-1"></i>
                            <div class="flex-1">
                                <div class="font-semibold text-red-800">${delivery.material_type || 'Unknown'}</div>
                                <div class="text-sm text-red-700">Delayed by ${delivery.delay_days} days</div>
                                <div class="text-xs text-gray-600">PO: ${delivery.po_ref}</div>
                            </div>
                        </div>
                    </div>
                `;
                container.append(html);
            });
        }
    });
}

function getStatusClass(status) {
    const classes = {
        'Pending': 'bg-yellow-100 text-yellow-800 border border-yellow-300',
        'In Transit': 'bg-blue-100 text-blue-800 border border-blue-300',
        'Completed': 'bg-green-100 text-green-800 border border-green-400',
        'Delayed': 'bg-red-100 text-red-800 border border-red-300',
        'Partial Delivery': 'bg-purple-100 text-purple-800 border border-purple-300'
    };
    return classes[status] || 'bg-gray-100 text-gray-800 border border-gray-300';
}

// Initialize
$(document).ready(function() {
    // Set current date
    const today = new Date();
    $('#current-date').text(today.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    }));
    
    // Load data
    loadDashboardStats();
    loadUpcomingDeliveries();
    loadAlerts();
    
    // Refresh every 30 seconds
    setInterval(function() {
        loadDashboardStats();
        loadUpcomingDeliveries();
        loadAlerts();
    }, 30000);
});
</script>
{% endblock %}
